## Getting Started

While it's not required, ideally, you should have a general understanding of OSI Model [Layer 2](https://en.wikipedia.org/wiki/Data_link_layer) (L2) [network switches](https://en.wikipedia.org/wiki/Network_switch) work, what a [MAC table](https://en.wikipedia.org/wiki/MAC_table) is, what the Address Resolution Protocol ([ARP](https://en.wikipedia.org/wiki/Address_Resolution_Protocol)) does, and how to use Wireshark at a basic level. If you're not comfortable with these topics, please check out the [Network](https://tryhackme.com/module/network-fundamentals) and [Linux](https://tryhackme.com/module/linux-fundamentals) Fundamentals modules and [Wireshark](https://tryhackme.com/room/wireshark) room. ^00a9fa

> **“L2”** means **Layer 2**  
> This refers to the **Data Link Layer** of the OSI model. At this layer, devices communicate using **MAC addresses** (hardware addresses).
<div align="center">
<br>
<br>
</div>

### MAC Flooding

==DEF-MAC Flooding is an attack where an attacker floods a network switch with a large number of fake MAC addresses.==

**Why it works:**  
A switch uses a **MAC address table (CAM table)** to remember which MAC addresses are reachable on which physical ports. When the table is full, the switch can’t keep track anymore.

**Result:**  
The switch acts like a hub — it sends all traffic to all ports. This allows the attacker to **sniff network traffic** that wasn’t meant for them.
<div align="center">
<br>
<br>
</div>

### ARP Spoofing

ARP stands for **Address Resolution Protocol**. It maps IP addresses to MAC addresses inside a local network.

==DEF-ARP Spoofing (or ARP Poisoning) is a network attack where an attacker sends **forged ARP (Address Resolution Protocol) messages** onto a local area network (LAN) to **associate their MAC address with the IP address of another device**, like the default gateway or another host.==

**How the attack works:**  
An attacker sends fake ARP messages on the network. For example, they can say: _“Hey everyone, the gateway’s IP address is actually my MAC address!”_  
Devices believe it — so they send their traffic to the attacker instead of the real router.

**Result:**  
The attacker performs a **Man-in-the-Middle (MITM)** attack. They can:
- Read network traffic
- Modify it
- Steal credentials, cookies, etc.
<div align="center">
<br>
<br>
</div>

### How they work together

In practice:
- **MAC Flooding** is used to make the switch forward all packets to all ports.
- **ARP Spoofing** poisons the network’s IP-MAC relationships so traffic is rerouted through the attacker’s machine.

Both techniques help attackers sniff or manipulate network data inside a **local network** (like a LAN).
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Initial Access

_For the sake of this room, let's assume the following:_

While conducting a pentest, you have gained initial access to a network and escalated privileges to root on a Linux machine. During your routine OS enumeration, you realize it's a [dual-homed](https://en.wikipedia.org/wiki/Dual-homed) host, meaning it is connected to two (or more) networks. Being the curious hacker you are, you decided to explore this network to see if you can move laterally.

After having established **persistence**, you can access the compromised host via **SSH**:

| **User** | **Password** | **IP**       | **Port** |
| -------- | ------------ | ------------ | -------- |
| admin    | Layer2       | 10.10.244.13 | 22       |

`ssh -o StrictHostKeyChecking=accept-new admin@10.10.244.13`

Note: The **admin** user is in the **sudo** group. I suggest using the **root** user to complete this room: `sudo su -`

### Questions

##### Now, can you (re)gain access? (Yay/Nay)

![[Pasted image 20250709192004.png]]
![[Pasted image 20250709192258.png]]
![[Pasted image 20250709192515.png]]

---


## Network Discovery

As mentioned previously, the host is connected to one or more additional networks. You are currently connected to the machine via SSH on Ethernet adapter **eth0**. The network of interest is connected with Ethernet adapter **eth1**.

First, have a look at the adapter:  

`ip address show eth1` or the shorthand version: `ip a s eth1`

Using this knowledge, answer questions **#1** and **#2**.

Now, use the network enumeration tool of your choice, e.g., **ping**, a bash or python script, or Nmap (pre-installed) to discover other hosts in the network and answer question **#3**.

### Questions

##### What is your IP address?  
192.168.12.66

![[Pasted image 20250710092612.png]]

##### What's the network's CIDR prefix?  
/24 

![[Pasted image 20250710092720.png]]

##### How many other live hosts are there?  
2

![[Pasted image 20250710093322.png]]

##### What's the hostname of the first host (lowest IP address) you've found?
alice

![[Pasted image 20250710093909.png]]

---

## Passive Network Sniffing

Simply scanning those hosts won't help us gather any useful information, and you may be asking, what could a pentester do in this situation? Depending on the **rules of engagement** and **scope**, you could try **sniffing** traffic on this network.

The diagram below describes your current situation where you are the **Attacker** and have persistent access to **eve.**

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5e9955140ab79a04b28162eb/room-content/f19dfb6c3e6771ba582f1994ca54648a.png)  

Let's try running **tcpdump** on the **eth1** network interface:

`tcpdump -i eth1`

Optionally, for a more verbose output that prints each packet (minus its link level header) in ASCII format:

`tcpdump -A -i eth1   `

Try to answer questions **#1** through **#2**.  

Now, let's take a closer look at the captured packets! We can redirect them into a **pcap** file providing a destination file via the **-w** argument:

`tcpdump -A -i eth1 -w /tmp/tcpdump.pcap`

Capture traffic for about a minute, then transfer the pcap to either your machine or the AttackBox to open it in Wireshark.

Example to transfer the packet capture using **scp** and open it in Wireshark:

`scp admin@10.10.37.150:/tmp/tcpdump.pcap .`
`wireshark tcpdump.pcap`

Now, you should be able to answer questions **#3** and **#4**.

Note: If you receive an error "tcpdump: /tmp/tcpdump.pcap: Permission denied" and cannot overwrite the existing **/tmp/tcpdump.pcap** file, specify a new filename such as tcpdump**2**.pcap, or run `rm -f /tmp/*.pcap` then re-run **tcpdump**.

### Questions

##### Can you see any traffic from those hosts? (Yay/Nay)
Yay

![[Pasted image 20250710102538.png]]

##### Who keeps sending packets to eve?
bob

![[Pasted image 20250710102652.png]]

##### What type of packets are sent?
ICMP

![[Pasted image 20250710102758.png]]

##### What's the size of their data section? (bytes)
666

![[Pasted image 20250710111450.png]]
![[Pasted image 20250710111544.png]]
![[Pasted image 20250710111853.png]]


---

## Sniffing while MAC Flooding

Unfortunately, we weren't able to capture any interesting traffic so far. However, we're not going to give up this easily! So, how can we capture more network traffic? As mentioned in the room description, we could try to launch a [MAC flooding](https://en.wikipedia.org/wiki/MAC_flooding) attack against the L2-Switch.

**Beware:** MAC flooding could trigger an alarm in a SOC. No, seriously, suspicious layer 2 traffic can easily be detected and reported by state-of-the-art and properly configured network devices. Even worse, your network port could even get blocked by the network device altogether, rendering your machine locked out of the network. In case of production services running on or production traffic being routed through that network connection, this could even result in an effective **Denial-of-Service**!

However, if we're successful, the switch will resort to fail-open mode and temporarily operate similarly to a network hub – forwarding all received frames to every connected port (aside from the port the traffic originated from). This would allow an adversary or pentester to sniff the network traffic between other hosts that normally wouldn't be received by their device if the switch were functioning properly.  

Considering such an attack vector is only recommended when you have reasons to believe that…

- It is in fact a switched network (and not a virtual bridge) **AND**  
- The switch might be a consumer or prosumer (unmanaged) switch **OR** the network admins haven't configured mitigations such as Dynamic ARP Inspection (DAI) for instance **AND**
- ARP and MAC spoofing attacks are explicitly permitted in the **rules of engagement**. When in doubt, clarify with your client first!  

_Anyhow, let's assume you've met the well-thought decision to give it a try._

For better usability, open a second SSH session. This way, you can leave the **tcpdump** process running in the foreground on the first SSH session:

`tcpdump -A -i eth1 -w /tmp/tcpdump2.pcap`

Now, on the second SSH session, buckle up and let **[macof](http://manpages.ubuntu.com/manpages/bionic/man8/macof.8.html)** run against the interface to start flooding the switch:  

`macof -i eth1`

After around 30 seconds, stop both **macof** and **tcpdump** (Ctrl+C).

As in the previous task, transfer the **pcap** to your machine (**kali/AttackBox)** and take a look:

`scp admin@10.10.37.150:/tmp/tcpdump2.pcap .   wireshark tcpdump2.pcap   `

Now, you should be able to answer questions **#1** and **#2**.

**Note:** If it didn't work, try to capture for 30 seconds, again (while **macof** is running).  
If it still won't work, give it one last try with a capture duration of one minute.  
As the measure of last resort, try using **[ettercap](https://www.kali.org/tools/ettercap/)** (introduced in the following tasks) with the **rand_flood** plugin:

`ettercap -T -i eth1 -P rand_flood -q -w /tmp/tcpdump3.pcap` (Quit with **q**)

### Questions

##### What kind of packets is Alice continuously sending to Bob?


##### What's the size of their data section? (bytes)



---

### Questions

##### 

---

### Questions

##### 



## References

https://tryhackme.com/room/layer2
