## Getting Started

While it's not required, ideally, you should have a general understanding of OSI Model [Layer 2](https://en.wikipedia.org/wiki/Data_link_layer) (L2) [network switches](https://en.wikipedia.org/wiki/Network_switch) work, what a [MAC table](https://en.wikipedia.org/wiki/MAC_table) is, what the Address Resolution Protocol ([ARP](https://en.wikipedia.org/wiki/Address_Resolution_Protocol)) does, and how to use Wireshark at a basic level. If you're not comfortable with these topics, please check out the [Network](https://tryhackme.com/module/network-fundamentals) and [Linux](https://tryhackme.com/module/linux-fundamentals) Fundamentals modules and [Wireshark](https://tryhackme.com/room/wireshark) room. ^00a9fa

> **“L2”** means **Layer 2**  
> This refers to the **Data Link Layer** of the OSI model. At this layer, devices communicate using **MAC addresses** (hardware addresses).
<div align="center">
<br>
<br>
</div>

### MAC Flooding

==DEF-MAC Flooding is an attack where an attacker floods a network switch with a large number of fake MAC addresses.==

**Why it works:**  
A switch uses a **MAC address table (CAM table)** to remember which MAC addresses are reachable on which physical ports. When the table is full, the switch can’t keep track anymore.

**Result:**  
The switch acts like a hub — it sends all traffic to all ports. This allows the attacker to **sniff network traffic** that wasn’t meant for them.
<div align="center">
<br>
<br>
</div>

### ARP Spoofing

ARP stands for **Address Resolution Protocol**. It maps IP addresses to MAC addresses inside a local network.

==DEF-ARP Spoofing (or ARP Poisoning) is a network attack where an attacker sends **forged ARP (Address Resolution Protocol) messages** onto a local area network (LAN) to **associate their MAC address with the IP address of another device**, like the default gateway or another host.==

**How the attack works:**  
An attacker sends fake ARP messages on the network. For example, they can say: _“Hey everyone, the gateway’s IP address is actually my MAC address!”_  
Devices believe it — so they send their traffic to the attacker instead of the real router.

**Result:**  
The attacker performs a **Man-in-the-Middle (MITM)** attack. They can:
- Read network traffic
- Modify it
- Steal credentials, cookies, etc.
<div align="center">
<br>
<br>
</div>

### How they work together

In practice:
- **MAC Flooding** is used to make the switch forward all packets to all ports.
- **ARP Spoofing** poisons the network’s IP-MAC relationships so traffic is rerouted through the attacker’s machine.

Both techniques help attackers sniff or manipulate network data inside a **local network** (like a LAN).
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Initial Access

_For the sake of this room, let's assume the following:_

While conducting a pentest, you have gained initial access to a network and escalated privileges to root on a Linux machine. During your routine OS enumeration, you realize it's a [dual-homed](https://en.wikipedia.org/wiki/Dual-homed) host, meaning it is connected to two (or more) networks. Being the curious hacker you are, you decided to explore this network to see if you can move laterally.

After having established **persistence**, you can access the compromised host via **SSH**:

| **User** | **Password** | **IP**       | **Port** |
| -------- | ------------ | ------------ | -------- |
| admin    | Layer2       | 10.10.244.13 | 22       |

`ssh -o StrictHostKeyChecking=accept-new admin@10.10.244.13`

Note: The **admin** user is in the **sudo** group. I suggest using the **root** user to complete this room: `sudo su -`

### Questions

##### Now, can you (re)gain access? (Yay/Nay)
Yay

![[Pasted image 20250709192004.png]]
![[Pasted image 20250709192258.png]]
![[Pasted image 20250709192515.png]]
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Network Discovery

As mentioned previously, the host is connected to one or more additional networks. You are currently connected to the machine via SSH on Ethernet adapter **eth0**. The network of interest is connected with Ethernet adapter **eth1**.

First, have a look at the adapter:  

`ip address show eth1` or the shorthand version: `ip a s eth1`

Using this knowledge, answer questions **#1** and **#2**.

Now, use the network enumeration tool of your choice, e.g., **ping**, a bash or python script, or Nmap (pre-installed) to discover other hosts in the network and answer question **#3**.

### Questions

##### What is your IP address?  
192.168.12.66

![[Pasted image 20250710092612.png]]

##### What's the network's CIDR prefix?  
/24 

![[Pasted image 20250710092720.png]]

##### How many other live hosts are there?  
2

![[Pasted image 20250710093322.png]]

##### What's the hostname of the first host (lowest IP address) you've found?
alice

![[Pasted image 20250710093909.png]]
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Passive Network Sniffing

Simply scanning those hosts won't help us gather any useful information, and you may be asking, what could a pentester do in this situation? Depending on the **rules of engagement** and **scope**, you could try **sniffing** traffic on this network.

The diagram below describes your current situation where you are the **Attacker** and have persistent access to **eve.**

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5e9955140ab79a04b28162eb/room-content/f19dfb6c3e6771ba582f1994ca54648a.png)  

Let's try running **tcpdump** on the **eth1** network interface:

`tcpdump -i eth1`

Optionally, for a more verbose output that prints each packet (minus its link level header) in ASCII format:

`tcpdump -A -i eth1   `

Try to answer questions **#1** through **#2**.  

Now, let's take a closer look at the captured packets! We can redirect them into a **pcap** file providing a destination file via the **-w** argument:

`tcpdump -A -i eth1 -w /tmp/tcpdump.pcap`

Capture traffic for about a minute, then transfer the pcap to either your machine or the AttackBox to open it in Wireshark.

Example to transfer the packet capture using **scp** and open it in Wireshark:

`scp admin@10.10.37.150:/tmp/tcpdump.pcap .`
`wireshark tcpdump.pcap`

Now, you should be able to answer questions **#3** and **#4**.

Note: If you receive an error "tcpdump: /tmp/tcpdump.pcap: Permission denied" and cannot overwrite the existing **/tmp/tcpdump.pcap** file, specify a new filename such as tcpdump**2**.pcap, or run `rm -f /tmp/*.pcap` then re-run **tcpdump**.
<div align="center">
<br>
<br>
</div>

### Questions

##### Can you see any traffic from those hosts? (Yay/Nay)
Yay

![[Pasted image 20250710102538.png]]
<div align="center">
<br>
</div>

##### Who keeps sending packets to eve?
bob

![[Pasted image 20250710102652.png]]
<div align="center">
<br>
</div>

##### What type of packets are sent?
ICMP

![[Pasted image 20250710102758.png]]
<div align="center">
<br>
</div>

##### What's the size of their data section? (bytes)
666

![[Pasted image 20250710111450.png]]
![[Pasted image 20250710111544.png]]
![[Pasted image 20250710111853.png]]
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Sniffing while MAC Flooding

Unfortunately, we weren't able to capture any interesting traffic so far. However, we're not going to give up this easily! So, how can we capture more network traffic? As mentioned in the room description, we could try to launch a [MAC flooding](https://en.wikipedia.org/wiki/MAC_flooding) attack against the L2-Switch.

**Beware:** MAC flooding could trigger an alarm in a SOC. No, seriously, suspicious layer 2 traffic can easily be detected and reported by state-of-the-art and properly configured network devices. Even worse, your network port could even get blocked by the network device altogether, rendering your machine locked out of the network. In case of production services running on or production traffic being routed through that network connection, this could even result in an effective **Denial-of-Service**!

However, if we're successful, the switch will resort to fail-open mode and temporarily operate similarly to a network hub – forwarding all received frames to every connected port (aside from the port the traffic originated from). This would allow an adversary or pentester to sniff the network traffic between other hosts that normally wouldn't be received by their device if the switch were functioning properly.  

Considering such an attack vector is only recommended when you have reasons to believe that…

- It is in fact a switched network (and not a virtual bridge) **AND**  
- The switch might be a consumer or prosumer (unmanaged) switch **OR** the network admins haven't configured mitigations such as Dynamic ARP Inspection (DAI) for instance **AND**
- ARP and MAC spoofing attacks are explicitly permitted in the **rules of engagement**. When in doubt, clarify with your client first!  

_Anyhow, let's assume you've met the well-thought decision to give it a try._

For better usability, open a second SSH session. This way, you can leave the **tcpdump** process running in the foreground on the first SSH session:

`tcpdump -A -i eth1 -w /tmp/tcpdump2.pcap`

Now, on the second SSH session, buckle up and let **[macof](http://manpages.ubuntu.com/manpages/bionic/man8/macof.8.html)** run against the interface to start flooding the switch:  

`macof -i eth1`

After around 30 seconds, stop both **macof** and **tcpdump** (Ctrl+C).

As in the previous task, transfer the **pcap** to your machine (**kali/AttackBox)** and take a look:

`scp admin@10.10.37.150:/tmp/tcpdump2.pcap .   wireshark tcpdump2.pcap   `

Now, you should be able to answer questions **#1** and **#2**.

**Note:** If it didn't work, try to capture for 30 seconds, again (while **macof** is running).  
If it still won't work, give it one last try with a capture duration of one minute.  
As the measure of last resort, try using **[ettercap](https://www.kali.org/tools/ettercap/)** (introduced in the following tasks) with the **rand_flood** plugin:

`ettercap -T -i eth1 -P rand_flood -q -w /tmp/tcpdump3.pcap` (Quit with **q**)
<div align="center">
<br>
<br>
</div>

### Questions

##### What kind of packets is Alice continuously sending to Bob?

Start by turning on the tcpdump listening mode, and don’t forget to also write the output to a new .pcap file called “tcpdump2.pcap” and save it to the /tmp/ directory.

```shell
admin@eve:~$ sudo tcpdump -A -i eth1 -w /tmp/tcpdump2.pcap
[sudo] password for admin:
tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
^C212604 packets captured
212604 packets received by filter
0 packets dropped by kernel
```

Then open up a second SSH session, and type in the following command to start the MAC flooding attack.

```shell
admin@eve:~$ sudo macof -i eth1
e8:46:e9:68:34:52 b3:4b:8b:17:de:cb 0.0.0.0.18602 > 0.0.0.0.46920: S 1041758322:1041758322(0) win 512
5b:27:3b:69:69:9e ac:b3:12:41:3b:0 0.0.0.0.56708 > 0.0.0.0.37201: S 1765967874:1765967874(0) win 512
d3:59:88:27:b2:6d a0:a3:bd:2:89:e5 0.0.0.0.40940 > 0.0.0.0.64003: S 566850551:566850551(0) win 512
42:42:db:42:91:c5 e9:b9:b:11:5c:e8 0.0.0.0.47620 > 0.0.0.0.55834: S 1131137431:1131137431(0) win 512
21:a5:6b:11:99:1d 86:3f:73:4f:4b:ab 0.0.0.0.62345 > 0.0.0.0.64345: S 1442383875:1442383875(0) win 512
ba:f2:fc:1a:57:df ef:99:91:38:15:b4 0.0.0.0.11081 > 0.0.0.0.25805: S 352541912:352541912(0) win 512
bc:f3:d1:69:f8:f6 8b:33:11:53:83:28 0.0.0.0.32317 > 0.0.0.0.6491: S 1953037759:1953037759(0) win 512
56:86:94:3:b4:a8 46:e3:93:45:e4:18 0.0.0.0.58766 > 0.0.0.0.18314: S 1669684867:1669684867(0) win 512
e1:53:77:58:bf:cf e6:1d:fc:4:d8:fe 0.0.0.0.63151 > 0.0.0.0.12062: S 1873829088:1873829088(0) win 512
f8:64:30:b:1e:aa 5e:8a:26:55:c4:f6 0.0.0.0.36561 > 0.0.0.0.20703: S 1129092328:1129092328(0) win 512
52:19:ce:42:1f:62 a:dc:a3:4d:fa:4 0.0.0.0.52136 > 0.0.0.0.57489: S 163232637:163232637(0) win 512
37:51:e5:52:90:71 82:77:ef:65:fe:c6 0.0.0.0.44737 > 0.0.0.0.59161: S 1157516135:1157516135(0) win 512
...
^C
```

After around 30 seconds, stop both macof and tcpdump (Ctrl+C). As in the previous task, transfer the pcap file from the remote server to your local machine.

```shell
root@ip-10-10-245-92:~# scp admin@10.10.139.235:/tmp/tcpdump2.pcap .
admin@10.10.139.235's password:
tcpdump2.pcap                            100%   14MB 122.0MB/s   00:00
```

```shell
┌──(mopsy㉿APHP)-[~/THM]
└─$ scp root@54.216.59.129:/root/tcpdump2.pcap .
root@54.216.59.129's password:
tcpdump2.pcap                            100%   14MB   2.4MB/s   00:05
```

The next step is to open up the .pcap file with Wireshark.

```shell
┌──(mopsy㉿APHP)-[~/THM]
└─$ wireshark tcpdump2.pcap
```

This question is asking for the kind of packets Alice is continuously sending to Bob. You can’t find either Alice or Bob in the .pcap file so it is important to go back to the diagram in task 4 to find their IP addresses first. Alice’s IP is 192.168.12.1 and Bob’s IP is 192.168.12.2.

With this information in mind, you can do a quick filter to look for packets with source IP address being Alice’s IP which is 192.168.12.1. Answer is under the “protocol” column.

![[Pasted image 20250806082715.png]]
<div align="center">
<br>
</div>

##### What's the size of their data section? (bytes)
You can find this information by clicking into one of the entries. When you see the new pop-up window, go straight to the “Internet Control Message Protocol” and you’ll see “Data (1337 bytes)” which is the answer.

![[Pasted image 20250806083351.png]]
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## 6. Man-in-the-Middle: Intro to ARP Spoofing
<div align="center">
<br>
<br>
</div>

### Questions

##### 


---

### Questions

##### 



## References

https://tryhackme.com/room/layer2
